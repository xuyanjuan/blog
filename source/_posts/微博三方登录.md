---
title: 微博三方登录

date: 2018/2/2 21:10:43

updated: 2018/2/2 21:10:43

categories:
 - 三方登录
 
tags:
 - 微博
---
![20200826102636292.jpg](https://i.loli.net/2021/02/01/mGWJefdCR9EaIlk.jpg)

**先注册微博开放平台：https://open.weibo.com**

**拿到 App Key 和 App Secret**

**填写回调地址**

**请求方式和URL：**
~~~
GET/POST   https://api.weibo.com/oauth2/authorize 
~~~
**前端的扫码地址**
~~~
<a href="https://api.weibo.com/oauth2/authorize?
            client_id=1968976007&
            redirect_uri=http://127.0.0.1:8080/wb_return_url">微博登录</a>
            <!-- client_id是App Key -->
            <!-- redirect_url是填写的回调地址 -->
~~~
**前端页面接收这个 code 然后发送给后台 Django**
~~~
<template>
    <div>
    {{message}}
    </div>
</template>

<script>
import axios from 'axios'
export default {
data() {
            return{
                message:'',
                code:this.$route.query.code

            }
        },
        mounted() {
            var code = this.$route.query.code;
            var form_data = new FormData();
            form_data.append('code', code);
            console.log(code);
            axios({
                'url': '/get_weibo_code/',
                'method': 'post',
                'data': form_data
            })
        }
}
</script>

<style>

</style>
~~~
**接收 微博回调页面 发送的 code**
~~~
class Get_WeiBo_Code(APIView):
    def post(self, request):
        code = request.data['code']
        print(code)
        # 通过 code 获取授权的 access_token
        access_token = get_weibo_accesstoken(code)
        uid = get_weibo_userinfo(access_token)
~~~
**通过 授权过的 token 获取 Access_token**
~~~
def get_weibo_accesstoken(code):
    # 获取 access_token 的必要参数 ↓
    url = 'https://api.weibo.com/oauth2/access_token'
    data = {
        'client_id': ' ',  # 创建应用的 App Key
        'client_secret': ' ',  # 创建应用的 App Secret
        'grant_type': 'authorization_code',  # 文档 写死
        'redirect_uri': ' ',  # 回调地址
        'code': code  # 接收到的编码
    }
    # 构造 post 对 weibo 的 url 发起请求
    res = requests.post(url=url, data=data).text
        # 得到请求转换为 字典 然后 取 键
    return json.loads(res)['access_token']
~~~ 
**查询 Access_token 的相关信息 (获取 weibo 唯一标识符 uid)**
~~~
def get_weibo_userinfo(access_token):
    url = 'https://api.weibo.com/oauth2/get_token_info'
    data = {
        'access_token': access_token,
    }
    res = requests.post(url=url, data=data).text
    return json.loads(res)['uid']
~~~
**model表**
~~~
class Social(models.Model):
    uid = models.CharField(max_length=100, verbose_name='uid')
    user = models.ForeignKey('User', on_delete=models.CASCADE)

    THIRD_PARTY_CHOICE = {
         (1, 'QQ'),
         (2, 'WX'),
         (3, 'WB'),
    }
    third_party = models.IntegerField(choices=THIRD_PARTY_CHOICE)

    def __str__(self):
        return self.user.name
~~~
**判断 用户之前 是否绑定过 微博，绑定过 就直接登录，没绑定过 重新 绑定一下**
~~~
class Get_WeiBo_Code(APIView):
    def post(self, request):
        code = request.data['code']
        print(code)
        # 通过 code 获取授权的 access_token
        access_token = get_weibo_accesstoken(code)
        uid = get_weibo_userinfo(access_token)
        # 从数据库 取 数据判断 用户是否 注册过
        try:
            s = models.Social.objects.get(
                third_party=3,  # 直接绑定微博
                uid=uid
            )
        except:
            # 当 抛出异常就代表没有（微博用户）
            # 给出对应的 数据
            return Response({
                'code': '10030',
                'message': '用户不存在，请绑定本站',
                'uid': uid
            })
        else:
            # 没有 异常 代表曾经注册过
            # 生成 token 保存登录状态
            data = {
                'id': s.user.id,
                'email': s.user.email
            }

            jwt_token = t.dumps(data).decode()
            # 发送到前台
            return Response({
                'code': 200,
                'message': '您是本站的老用户',
                'token': jwt_token,
                'email': s.user.email
            })
~~~